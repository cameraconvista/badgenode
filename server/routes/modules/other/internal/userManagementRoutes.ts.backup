// User management routes
import { Router } from 'express';
import { createClient } from '@supabase/supabase-js';
import { supabaseAdmin } from '../../../../lib/supabaseAdmin';
import { generateRequestId } from '../internal/helpers';

const router = Router();

// TEST /api/utenti/test-permissions - Testa permessi Supabase
router.get('/api/utenti/test-permissions', async (req, res) => {
  try {
    // Usa il client normale (ANON_KEY) per testare permessi
    const supabaseUrl = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL;
    const supabaseKey = process.env.VITE_SUPABASE_ANON_KEY;

    if (!supabaseUrl || !supabaseKey) {
      return res.status(503).json({
        success: false,
        error: 'Configurazione Supabase client mancante',
        code: 'SERVICE_UNAVAILABLE'
      });
    }

    const supabase = createClient(supabaseUrl, supabaseKey);
    const { data, error } = await supabase
      .from('utenti')
      .select('pin, nome, cognome')
      .limit(5);

    if (error) {
      return res.json({
        success: false,
        error: error.message,
        code: 'PERMISSION_DENIED',
        hasReadAccess: false
      });
    }

    res.json({
      success: true,
      hasReadAccess: true,
      recordCount: data?.length || 0,
      sampleData: data?.slice(0, 2) || []
    });
  } catch (error) {
    console.error('[API] Errore test permissions:', error);
    res.status(500).json({
      success: false,
      error: error instanceof Error ? error.message : 'Errore interno',
      code: 'INTERNAL_ERROR'
    });
  }
});

// DELETE /api/utenti/:pin - Elimina utente (richiede SERVICE_ROLE_KEY)
router.delete('/api/utenti/:pin', async (req, res) => {
  try {
    if (!supabaseAdmin) {
      return res.status(503).json({
        success: false,
        error: 'Servizio admin non disponibile - configurazione Supabase mancante',
        code: 'SERVICE_UNAVAILABLE'
      });
    }

    const { pin } = req.params;
    const pinNum = parseInt(pin, 10);

    if (isNaN(pinNum) || pinNum < 1 || pinNum > 99) {
      return res.status(400).json({
        success: false,
        error: 'PIN deve essere tra 1 e 99',
        code: 'INVALID_PIN'
      });
    }

    const { data, error } = await supabaseAdmin
      .from('utenti')
      .delete()
      .eq('pin', pinNum)
      .select();

    if (error) {
      console.warn('[API] Error deleting utente:', error.message);
      return res.status(500).json({
        success: false,
        error: 'Errore durante l\'eliminazione dell\'utente',
        code: 'QUERY_ERROR'
      });
    }

    if (!data || data.length === 0) {
      return res.status(404).json({
        success: false,
        error: `Utente con PIN ${pinNum} non trovato`,
        code: 'NOT_FOUND'
      });
    }

    res.json({
      success: true,
      message: `Utente con PIN ${pinNum} eliminato`,
      deletedUser: data[0]
    });
  } catch (error) {
    console.error('[API] Errore eliminazione utente:', error);
    res.status(500).json({
      success: false,
      error: error instanceof Error ? error.message : 'Errore interno',
      code: 'INTERNAL_ERROR'
    });
  }
});

// POST /api/utenti/:id/archive - Archivia utente con doppia conferma
router.post('/api/utenti/:id/archive', async (req, res) => {
  const requestId = (req.headers['x-request-id'] as string) || generateRequestId();
  const { id } = req.params;
  const { reason } = req.body;
  
  try {
    if (!supabaseAdmin) {
      return res.status(503).json({
        success: false,
        error: 'Servizio admin non disponibile - configurazione Supabase mancante',
        code: 'SERVICE_UNAVAILABLE'
      });
    }

    // Validazione ID utente
    if (!id) {
      return res.status(400).json({
        success: false,
        error: 'ID utente obbligatorio',
        code: 'MISSING_PARAMS'
      });
    }

    // Verifica che l'utente esista e sia attivo (usa PIN come chiave)
    const { data: utente, error: userError } = await supabaseAdmin
      .from('utenti')
      .select('pin, nome, cognome')
      .eq('pin', id)
      .single();

    if (userError || !utente) {
      return res.status(404).json({
        success: false,
        error: 'Utente non trovato',
        code: 'USER_NOT_FOUND'
      });
    }

    // TODO(BUSINESS): Implementare controllo stato archiviato se necessario
    // if (utente.stato === 'archiviato') {
    //   return res.status(409).json({
    //     success: false,
    //     error: 'Utente già archiviato',
    //     code: 'ALREADY_ARCHIVED'
    //   });
    // }

    // TODO(BUSINESS): Pre-check sessioni aperte - disabilitato per test
    // Schema database diverso dalla documentazione
    // const { data: sessioneAperta, error: sessionError } = await supabaseAdmin
    //   .from('timbrature')
    //   .select('id, tipo')
    //   .eq('pin', utente.pin)
    //   .order('created_at', { ascending: false })
    //   .limit(1);
    
    console.log(`[API][archive][${requestId}] Skipping session check - schema mismatch`);

    // Archiviazione reale: inserisce in tabella ex_dipendenti
    const now = new Date().toISOString();
    const { error: archiveError } = await supabaseAdmin
      .from('ex_dipendenti')
      .insert([
        {
          pin: (utente as any).pin,
          nome: (utente as any).nome,
          cognome: (utente as any).cognome,
          archiviato_il: now,
        } as any,
      ] as any);

    if (archiveError) {
      console.error(`[API][archive][${requestId}] Archive failed:`, archiveError.message);
      return res.status(500).json({
        success: false,
        error: 'Archiviazione non riuscita. Riprova.',
        code: 'ARCHIVE_FAILED'
      });
    }

    // Rimuove l'utente dalla tabella utenti attivi
    const { error: deleteError } = await supabaseAdmin
      .from('utenti')
      .delete()
      .eq('pin', id);

    if (deleteError) {
      console.error(`[API][archive][${requestId}] Delete from utenti failed:`, deleteError.message);
      // Non blocchiamo l'operazione se il delete fallisce, l'utente è già archiviato
      console.warn(`[API][archive][${requestId}] User archived but not removed from utenti table`);
    }

    console.log(`[API][archive][${requestId}] User archived: ${(utente as any).nome} ${(utente as any).cognome} (PIN ${id})`);
    
    res.json({
      success: true,
      message: 'Dipendente archiviato con successo'
    });

  } catch (error) {
    console.error(`[API][archive][${requestId}] Error:`, error);
    res.status(500).json({
      success: false,
      error: error instanceof Error ? error.message : 'Errore interno',
      code: 'INTERNAL_ERROR'
    });
  }
});

// POST /api/utenti/:id/restore - Ripristina ex-dipendente assegnando un nuovo PIN
router.post('/api/utenti/:id/restore', async (req, res) => {
  const requestId = (req.headers['x-request-id'] as string) || generateRequestId();
  const { id } = req.params; // id = PIN ex-dipendente archiviato
  const { newPin } = req.body as { newPin?: string | number };

  try {
    if (!supabaseAdmin) {
      return res.status(503).json({
        success: false,
        error: 'Servizio admin non disponibile - configurazione Supabase mancante',
        code: 'SERVICE_UNAVAILABLE'
      });
    }

    if (!id) {
      return res.status(400).json({ success: false, error: 'ID utente obbligatorio', code: 'MISSING_PARAMS' });
    }

    const oldPinNum = parseInt(String(id), 10);
    if (isNaN(oldPinNum) || oldPinNum < 1 || oldPinNum > 99) {
      return res.status(400).json({ success: false, error: 'PIN non valido', code: 'INVALID_PIN' });
    }

    const newPinNum = parseInt(String(newPin ?? ''), 10);
    if (isNaN(newPinNum) || newPinNum < 1 || newPinNum > 99) {
      return res.status(400).json({ success: false, error: 'Nuovo PIN non valido (1-99)', code: 'INVALID_NEW_PIN' });
    }

    // Verifica che l'utente sia davvero archiviato
    const { data: exUser, error: exErr } = await supabaseAdmin
      .from('ex_dipendenti')
      .select('pin, nome, cognome')
      .eq('pin', oldPinNum)
      .maybeSingle();

    if (exErr || !exUser) {
      return res.status(409).json({ success: false, error: 'Utente non archiviato', code: 'USER_NOT_ARCHIVED' });
    }

    // Verifica disponibilità nuovo PIN
    const { data: pinCheck, error: pinErr } = await supabaseAdmin
      .from('utenti')
      .select('pin', { head: false, count: 'exact' })
      .eq('pin', newPinNum)
      .limit(1);
    if (pinErr) {
      console.warn(`[API][restore][${requestId}] PIN check error:`, pinErr.message);
    }
    if ((pinCheck && pinCheck.length > 0)) {
      return res.status(409).json({ success: false, error: 'PIN già in uso', code: 'PIN_IN_USE' });
    }

    // Inserisce nuovamente in utenti con il nuovo PIN
    const now = new Date().toISOString();
    const { error: insErr } = await supabaseAdmin
      .from('utenti')
      .insert([
        { pin: newPinNum, nome: (exUser as any).nome, cognome: (exUser as any).cognome, created_at: now } as any,
      ] as any);
    if (insErr) {
      console.error(`[API][restore][${requestId}] Insert utenti failed:`, insErr.message);
      return res.status(500).json({ success: false, error: 'Ripristino non riuscito', code: 'RESTORE_FAILED' });
    }

    // Rimuove dalla tabella ex_dipendenti il record originale
    const { error: delErr } = await supabaseAdmin
      .from('ex_dipendenti')
      .delete()
      .eq('pin', oldPinNum);
    if (delErr) {
      console.warn(`[API][restore][${requestId}] Delete ex_dipendenti failed:`, delErr.message);
      // Non annulliamo il restore se il delete fallisce: il record è già stato ripristinato tra gli attivi
    }

    return res.json({ success: true });
  } catch (error) {
    console.error(`[API][restore][${requestId}] Error:`, (error as Error)?.message || error);
    return res.status(500).json({ success: false, error: 'Errore interno', code: 'INTERNAL_ERROR' });
  }
});

// DELETE /api/ex-dipendenti/:pin - Eliminazione definitiva ex-dipendente
router.delete('/api/ex-dipendenti/:pin', async (req, res) => {
  const { pin } = req.params;
  const pinNum = parseInt(String(pin), 10);

  try {
    if (!supabaseAdmin) {
      return res.status(503).json({ success: false, error: 'Servizio admin non disponibile', code: 'SERVICE_UNAVAILABLE' });
    }

    if (isNaN(pinNum) || pinNum < 1 || pinNum > 99) {
      return res.status(400).json({ success: false, error: 'PIN non valido', code: 'INVALID_PIN' });
    }

    // Verifica che l'utente sia effettivamente archiviato
    const { data: archived, error: checkErr } = await supabaseAdmin
      .from('ex_dipendenti')
      .select('pin')
      .eq('pin', pinNum)
      .maybeSingle();
    if (checkErr || !archived) {
      return res.status(409).json({ success: false, error: 'Utente non archiviato', code: 'USER_NOT_ARCHIVED' });
    }

    // Hard delete dal registro ex_dipendenti (timbrature non toccate)
    const { error: delErr } = await supabaseAdmin
      .from('ex_dipendenti')
      .delete()
      .eq('pin', pinNum);

    if (delErr) {
      const code = (delErr as any)?.code || '';
      if (code === '23503') {
        return res.status(409).json({ success: false, error: 'Vincolo FK attivo', code: 'FK_CONSTRAINT' });
      }
      return res.status(500).json({ success: false, error: 'Eliminazione non riuscita', code: 'DELETE_FAILED' });
    }

    return res.json({ success: true });
  } catch (error) {
    return res.status(500).json({ success: false, error: 'Errore interno', code: 'INTERNAL_ERROR' });
  }
});

export { router as userManagementRoutes };
